name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: public.ecr.aws/m0t3o1p9
  IMAGE_NAME: caveo-api

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: node-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          node-${{ runner.os }}-
    - name: Install deps (clean)
      run: npm ci
    - name: TypeScript type check
      run: npx tsc --noEmit
    
    - name: Run ESLint
      run: npm run lint -- --max-warnings=100

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: node-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          node-${{ runner.os }}-
    - name: Install deps (clean)
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Run tests with coverage
      run: npm run test:coverage

  build:
    name: TypeScript Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: node-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          node-${{ runner.os }}-
    - name: Install deps (clean)
      run: npm ci
    
    - name: Build TypeScript
      run: npm run build

  build-and-deploy:
    name: Docker Build & Deploy
    needs: [lint, test, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Login to Amazon ECR Public
      id: login-ecr-public
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registry-type: public
    
    - name: Build and push Docker image
      run: |
        docker build --pull -t $REGISTRY/$IMAGE_NAME:latest -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} .
        docker push $REGISTRY/$IMAGE_NAME:latest
        docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
    
    - name: Deploy to EC2
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem
        
        ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
        set -e
        
        echo "[deploy] Installing jq if needed"
        command -v jq || sudo apt-get update -qq && sudo apt-get install -y jq
        
        echo "[deploy] Fetching secrets and creating .env"
        aws secretsmanager get-secret-value \
          --secret-id caveo/app/environment \
          --region us-east-1 \
          --query SecretString \
          --output text | jq -r 'to_entries[] | "\(.key)=\(.value)"' > .env
        
        echo "[deploy] Pulling latest image"
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        echo "[deploy] Stopping old container"
        docker stop caveo-api 2>/dev/null || true
        docker rm caveo-api 2>/dev/null || true
        
        echo "[deploy] Starting new container"
        docker run -d \
          --name caveo-api \
          -p 3000:3000 \
          --env-file .env \
          --restart unless-stopped \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        echo "[deploy] Waiting for health check"
        sleep 5
        for i in {1..12}; do
          if curl -f http://localhost:3000/health; then
            echo "[deploy] Health check passed"
            docker image prune -f
            exit 0
          fi
          sleep 5
        done
        
        echo "[deploy] Health check failed"
        docker logs caveo-api
        exit 1
        ENDSSH
        
        rm -f private_key.pem
